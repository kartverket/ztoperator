apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: audience-referencing
spec:
  skip: false
  concurrent: true
  skipDelete: false
  namespaceTemplate:
    metadata:
      name: chainsaw-manifest-validation
      labels:
        istio-injection: enabled

  steps:
    - try:
        - create:
            file: ../../../resources/skiperator/application.yaml
        - create:
            file: audience/authpolicy.yaml
        - script:
            content: |
              ./../../../../scripts/patch-invalid-spec.sh \
                audience/patch-invalid-audience.yaml \
                "one audience cannot be defined from both 'value' and 'valueFrom'"

              ./../../../../scripts/patch-invalid-spec.sh \
                audience/patch-invalid-audience-ref.yaml \
                "cannot reference both a ConfigMap and a Secret"                